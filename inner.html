<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="https://t4.oseale.com/favicon.png?v=2" type="image/png">
  <title>Inner.html | t4.oseale.com</title>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#000; }
    iframe { border:none; width:100vw; height:100vh; display:block; }
    #slideshowFrame { position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:1; }
    #debugMenu {
      position:fixed; bottom:20px; left:20px; padding:10px;
      background:#111; color:#0f0; border:1px solid #0f0;
      font-family:monospace; z-index:10000; display:none; white-space:pre;
    }
    .debug-visible #debugMenu { display:block; }

    .ldr {
      border: 12px solid #e0e0e0;
      border-top: 12px solid #3498db;
      border-bottom: 12px solid #FFD700;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 2s linear infinite;
      position: absolute;
      inset: 0;
      margin: auto;
      z-index: 1000;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }

      #offlineIndicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #c00;
        color: #fff;
        padding: 8px 14px;
        font-family: monospace;
        border-radius: 4px;
        z-index: 20000;
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="ldr"></div>
  <iframe id="slideshowFrame" src="" allowfullscreen></iframe>
  <div id="offlineIndicator">EI YHTEYTTÃ„</div>
  <div id="debugMenu"></div>

  <script>
    var CONFIG_URL = "https://script.google.com/macros/s/AKfycbxVt8q-GsdsmC4linHgu7X3NlSTzKZUmNSrqJ70GkQ4KZx0dPpC1eMBYrfanYsglRowLQ/exec";
    var DEFAULT_ID = "19q6v5NqyDLkIB89l-IFuDSy2njVl7bPuESDeXtLZCCQ";
    var DEFAULT_DELAY = 7000;

    var lastConfigTime = "";
    var currentId = "";
    var currentDelay = "";
    var nextRefreshTime = "";

    var loader = document.querySelector(".ldr");
    var iframe = document.getElementById("slideshowFrame");
    
    var offlineBox = document.getElementById("offlineIndicator");
  
    function updateOfflineStatus() {
      if (navigator.onLine) {
        offlineBox.style.display = "none";
      } else {
        offlineBox.style.display = "block";
      }
    }
    
    window.addEventListener("online", function () {
      updateOfflineStatus();
    });
    
    window.addEventListener("offline", function () {
      updateOfflineStatus();
    });
    
    // Initial check
    updateOfflineStatus();

    loader.style.display = "block";
    iframe.style.display = "none";

    iframe.addEventListener("load", function () {
      loader.style.display = "none";
      iframe.style.display = "block";
    });
    
    function loadInitialConfig() {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", CONFIG_URL, true);

      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          var cfg;
          if (xhr.status === 200) {
            try { cfg = JSON.parse(xhr.responseText); }
            catch (e) { cfg = {}; }
          } else {
            cfg = {};
          }
          applyInitialConfig(cfg);
        }
      };

      xhr.send();
    }

    function applyInitialConfig(cfg) {
      var id = cfg.slideshowId || DEFAULT_ID;
      var delay = cfg.slideDelay || DEFAULT_DELAY;

      currentId = id;
      currentDelay = delay;
      lastConfigTime = new Date().toLocaleTimeString();

      var url = "https://docs.google.com/presentation/d/" +
        id +
        "/embed?start=true&loop=true&delayms=" +
        delay +
        "&rm=minimal" +
        "&cb=" + Date.now(); 

      iframe.src = url;
    }

    function checkRefreshFlag() {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", CONFIG_URL, true);

      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var cfg;
          try { cfg = JSON.parse(xhr.responseText); }
          catch (e) { cfg = {}; }

          if (cfg.refreshAll === 1) {
            location.reload(true);
          }
        }
      };

      xhr.send();
    }

    function scheduleNextMinute() {
      var now = new Date();
      var ms = (60 - now.getSeconds()) * 1000 - now.getMilliseconds();
      var next = new Date(now.getTime() + ms);
      nextRefreshTime = next.toLocaleTimeString();

      setTimeout(function () {
        checkRefreshFlag();
        scheduleNextMinute();
      }, ms);
    }

    function updateDebug() {
      var box = document.getElementById("debugMenu");
      var now = new Date().toLocaleTimeString();
      box.textContent =
        "Time: " + now +
        "\nNext refresh: " + nextRefreshTime +
        "\nLast config load: " + lastConfigTime +
        "\nID: " + currentId +
        "\nDelay: " + currentDelay;
    }

    setInterval(updateDebug, 500);

    document.addEventListener("keydown", function (e) {
      if (e.key === "F3") {
        document.body.classList.toggle("debug-visible");
      }
    });

    loadInitialConfig();
    scheduleNextMinute();
  </script>
</body>
</html>
